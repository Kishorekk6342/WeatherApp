@inherits LayoutComponentBase

@using WeatherApp.Models
@using WeatherApp.Services

@inject JsSupabaseAuthService JsAuth
@inject AuthenticatedSupabaseClient AuthClient
@inject ProfileStateService ProfileState
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />


<MudLayout>

    <!-- TOP APP BAR -->
    <MudAppBar Elevation="4" Color="Color.Primary">

        <!-- LEFT: Menu -->
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />

        <MudSpacer />

        <!-- CENTER: App Title -->
        <MudText Typo="Typo.h6" Class="font-weight-bold">
            Weather App
        </MudText>

        <MudSpacer />

        <!-- RIGHT: Auth Section -->
        @if (_currentUser == null)
        {
            <MudButton Variant="Variant.Text"
                       Color="Color.Inherit"
                       OnClick="@(() => Nav.NavigateTo("/login"))">
                Login
            </MudButton>
        }
        else
        {
            var displayName = !string.IsNullOrWhiteSpace(ProfileState.Username)
            ? ProfileState.Username
            : _currentUser.Email;

            <!-- Avatar -->
            @if (!string.IsNullOrWhiteSpace(ProfileState.AvatarUrl))
            {
                <MudAvatar Size="Size.Medium" Class="mr-2">
                    <MudImage Src="@ProfileState.AvatarUrl" Alt="Profile" />
                </MudAvatar>
            }
            else
            {
                <MudAvatar Size="Size.Medium" Class="mr-2">
                    @displayName.FirstOrDefault()
                </MudAvatar>
            }

            <!-- Name -->
            <MudText Class="mr-3">@displayName</MudText>

            <!-- Logout -->
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="@LogoutAsync">
                Logout
            </MudButton>
        }
    </MudAppBar>

    <!-- LEFT DRAWER -->
    <MudDrawer @bind-Open="_drawerOpen"
               Anchor="Anchor.Left"
               Variant="DrawerVariant.Responsive"
               ClipMode="DrawerClipMode.Never">

        <MudNavMenu>
            <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All">
                Home
            </MudNavLink>

            @if (_currentUser != null)
            {
                <MudNavLink Href="/profile" Icon="@Icons.Material.Filled.Person">
                    Profile
                </MudNavLink>

                <MudNavLink Href="/recent-searches" Icon="@Icons.Material.Filled.History">
                    Recent Searches
                </MudNavLink>

                <MudNavLink Href="/favorites" Icon="@Icons.Material.Filled.Star">
                    Favorites
                </MudNavLink>
            }
        </MudNavMenu>
    </MudDrawer>

    <!-- MAIN CONTENT -->
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
            @Body
        </MudContainer>
    </MudMainContent>

</MudLayout>

@code {
    private bool _drawerOpen;
    private UserDto? _currentUser;

    protected override async Task OnInitializedAsync()
    {
        // 🔔 Listen for profile changes
        ProfileState.OnChange += StateHasChanged;

        await LoadUserAndProfileAsync();
    }

    public void Dispose()
    {
        // 🔕 Prevent memory leaks
        ProfileState.OnChange -= StateHasChanged;
    }

    private async Task LoadUserAndProfileAsync()
    {
        try
        {
            _currentUser = await JsAuth.GetCurrentUserAsync();
            if (_currentUser == null)
                return;

            var client = await AuthClient.GetAuthenticatedClientAsync();

            var response = await client
                .From<ProfileModel>()
                .Filter("id", Supabase.Postgrest.Constants.Operator.Equals, _currentUser.Id)
                .Get();

            var profile = response.Models.FirstOrDefault();
            if (profile != null)
            {
                // ✅ Push profile into shared state
                ProfileState.SetProfile(profile.Username, profile.AvatarUrl);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Layout load error: {ex.Message}");
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task LogoutAsync()
    {
        await JsAuth.LogoutAsync();

        _currentUser = null;
        ProfileState.SetProfile(null, null);

        Snackbar.Add("Logout successful", Severity.Success);
        Nav.NavigateTo("/login", forceLoad: true);
    }
}
