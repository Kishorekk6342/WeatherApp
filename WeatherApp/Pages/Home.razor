@page "/"
@inject WeatherService WeatherService
@inject WeatherHistoryService WeatherHistoryService
@inject IJSRuntime JS
@inject JsSupabaseAuthService JsAuth
@inject RecentSearchService RecentSearchService
@using WeatherApp.Models


<MudPaper Class="mx-auto mt-8 pa-6" MaxWidth="800px" Elevation="10">

    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">
        Weather Forecast
    </MudText>

    <MudText Align="Align.Center" Class="mb-4">
        Choose how you want to get the weather:
    </MudText>

    <!-- OPTIONS -->
    <MudGrid Class="mb-4" Justify="Justify.Center" Spacing="3">

        <!-- Current location -->
        <MudItem xs="12" md="5">
            <MudPaper Class="pa-4 d-flex flex-column align-center" Elevation="4">
                <MudIcon Icon="@Icons.Material.Filled.MyLocation" Size="Size.Large" Class="mb-2" />
                <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-2">
                    Use your current location
                </MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           OnClick="GetByLocationAsync">
                    USE CURRENT LOCATION
                </MudButton>
            </MudPaper>
        </MudItem>

        <!-- OR -->
        <MudItem xs="12" md="2" Class="d-flex justify-center align-center">
            <MudChip T="string" Variant="Variant.Outlined">OR</MudChip>
        </MudItem>

        <!-- City search -->
        <MudItem xs="12" md="5">
            <MudPaper Class="pa-4" Elevation="4">
                <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-2">
                    Search by city name
                </MudText>

                <MudStack Spacing="1">
                    <MudTextField @bind-Value="_city"
                                  Label="Enter City Name"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.LocationCity" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               FullWidth="true"
                               Disabled="@string.IsNullOrWhiteSpace(_city)"
                               OnClick="GetByCityAsync">
                        GET WEATHER
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @if (!string.IsNullOrEmpty(_status))
    {
        <MudAlert Severity="Severity.Info" Class="mb-2">@_status</MudAlert>
    }

    @if (!string.IsNullOrEmpty(_error))
    {
        <MudAlert Severity="Severity.Error" Class="mb-2">@_error</MudAlert>
    }

    <!-- TODAY WEATHER -->
    @if (_weather != null)
    {
        <MudPaper Class="pa-4 mt-4" Elevation="8">
            <MudText Typo="Typo.h5" Align="Align.Center">
                Today's Weather in @_weather.Name
            </MudText>

            <MudStack Row="true" Justify="Justify.SpaceAround" Class="mt-4">
                <MudStack AlignItems="AlignItems.Center">
                    <MudText>Temperature</MudText>
                    <MudText Typo="Typo.h6">@_weather.Main.Temp °C</MudText>
                </MudStack>

                <MudStack AlignItems="AlignItems.Center">
                    <MudText>Humidity</MudText>
                    <MudText Typo="Typo.h6">@_weather.Main.Humidity %</MudText>
                </MudStack>

                <MudStack AlignItems="AlignItems.Center">
                    <MudText>Wind Speed</MudText>
                    <MudText Typo="Typo.h6">@_weather.Wind.Speed m/s</MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    }

    <!-- PAST 7 DAYS WEATHER -->
    @if (_history != null && _history.Any())
    {
        <MudPaper Class="pa-4 mt-6" Elevation="6">
            <MudText Typo="Typo.h6" Class="mb-3">
                Past 7 Days Weather
            </MudText>

            <MudTable T="WeatherHistory"
                      Items="_history"
                      Dense="true"
                      Hover="true">

                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Min (°C)</MudTh>
                    <MudTh>Max (°C)</MudTh>
                    <MudTh>Condition</MudTh>
                    <MudTh>Humidity (%)</MudTh>
                </HeaderContent>

                <RowTemplate Context="context">
                    <MudTd>@context.WeatherDate.ToString("dd MMM")</MudTd>
                    <MudTd>@context.Temp_Min</MudTd>
                    <MudTd>@context.Temp_Max</MudTd>
                    <MudTd>@context.Condition</MudTd>
                    <MudTd>@context.Humidity</MudTd>
                </RowTemplate>



            </MudTable>

        </MudPaper>
    }

</MudPaper>

@code {

    string _city = "";
    string _status = "";
    string _error = "";

    WeatherResponse? _weather;
    List<WeatherHistory>? _history;

    async Task GetByCityAsync()
    {
        _error = "";
        _status = $"Fetching weather for {_city}...";

        try
        {
            _weather = await WeatherService.GetByCityAsync(_city);

            if (_weather == null)
            {
                _error = "No weather data found.";
                return;
            }

            _status = $"Showing weather for {_weather.Name}.";

            _history = await WeatherHistoryService.GetLast7Days(_weather.Name);

            var user = await JsAuth.GetCurrentUserAsync();
            if (user != null)
            {
                await RecentSearchService.AddAsync(_weather.Name);
            }

        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }


    async Task GetByLocationAsync()
    {
        _error = "";
        _status = "Getting your current location...";

        try
        {
            var pos = await JS.InvokeAsync<GeoPosition>(
                "weatherLocation.getCurrentPosition");

            _status = "Fetching weather for your location...";

            _weather = await WeatherService.GetByCoordsAsync(
                pos.Latitude, pos.Longitude);

            if (_weather == null)
            {
                _error = "No weather data found.";
                return;
            }

            _status = $"Showing weather for {_weather.Name}.";
            _history = await WeatherHistoryService.GetLast7Days(_weather.Name);

            var user = await JsAuth.GetCurrentUserAsync();
            if (user != null)
            {
                await RecentSearchService.AddAsync(_weather.Name);
            }

        }
        catch (Exception ex)
        {
            _error = "Location error: " + ex.Message;
        }
    }
}
