@page "/profile"
@using WeatherApp.Models
@using WeatherApp.Services
@inject JsSupabaseAuthService JsAuth
@inject AuthenticatedSupabaseClient AuthClient
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime


@inject ProfileStateService ProfileState

<MudPaper Class="mx-auto mt-8 pa-6" MaxWidth="700px" Elevation="10">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Profile</MudText>

    @if (!_loaded)
    {
        <div class="d-flex justify-center">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }
    else
    {
        <div class="d-flex flex-column align-center mb-4">
            <!-- Profile Picture Preview -->
            <MudAvatar Size="Size.Large" Style="width: 120px; height: 120px;">
                @if (!string.IsNullOrEmpty(_profilePictureUrl))
                {
                    <MudImage Src="@_profilePictureUrl" Alt="Profile" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                }
            </MudAvatar>

            <!-- Upload Profile Picture -->
            <InputFile OnChange="OnProfilePictureSelected" accept="image/*" style="display: none;" id="fileInput" />
            <MudButton HtmlTag="label"
                       Variant="Variant.Text"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.CloudUpload"
                       for="fileInput"
                       Class="mt-2">
                Change Profile Picture
            </MudButton>
        </div>

        <MudForm @ref="_form">
            <MudTextField @bind-Value="_username"
                          Label="Username"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Username is required."
                          HelperText="This is your display name"
                          FullWidth="true" />

            

            <MudTextField @bind-Value="_email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          FullWidth="true"
                          Disabled="true"
                          HelperText="Email cannot be changed"
                          Class="mt-3" />

            <div class="d-flex justify-end mt-4">
                <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="OnCancel">
                    Cancel
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@_saving"
                           OnClick="OnSaveAsync"
                           Class="ml-4">
                    @(_saving ? "Saving..." : "Save")
                </MudButton>
            </div>
        </MudForm>
    }
</MudPaper>

@code {
    private MudForm? _form;
    private bool _saving = false;
    private bool _loaded = false;
    private string _userId = string.Empty;
    private string _username = string.Empty;
    private string _fullName = string.Empty;
    private string _email = string.Empty;
    private string _profilePictureUrl = string.Empty;
    private IBrowserFile? _selectedFile;
    private Guid _userGuid;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = await JsAuth.GetCurrentUserAsync();
            if (user == null)
            {
                Nav.NavigateTo("/login");
                return;
            }

            _userGuid = Guid.Parse(user.Id);
            _userId = user.Id;  // ✅ Add this line
            _email = user.Email ?? string.Empty;

            // Load profile from database
            await LoadProfileFromDatabase();
        }

        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
            Snackbar.Add("Error loading profile", Severity.Error);
        }
        finally
        {
            _loaded = true;
        }
    }


    private async Task<bool> IsUsernameAvailableAsync(string username)
    {
        var client = await AuthClient.GetAuthenticatedClientAsync();

        var response = await client
            .From<ProfileModel>()
            .Filter("username", Supabase.Postgrest.Constants.Operator.Equals, username)
            .Get();

        // If no rows OR only current user's row → available
        return response.Models.Count == 0 ||
               response.Models.All(p => p.Id.ToString() == _userId);
    }


    private async Task LoadProfileFromDatabase()
    {
        try
        {
            var client = await AuthClient.GetAuthenticatedClientAsync();

            // ✅ Convert Guid to string for the filter
            var response = await client
                .From<ProfileModel>()
                .Filter("id", Supabase.Postgrest.Constants.Operator.Equals, _userGuid.ToString())
                .Get();

            var profile = response?.Models?.FirstOrDefault();

            if (profile != null)
            {
                _username = profile.Username ?? string.Empty;
                _profilePictureUrl = profile.AvatarUrl ?? string.Empty;
                ProfileState.SetProfile(_username, _profilePictureUrl);

                Console.WriteLine($"✅ Profile loaded: {_username}");
            }
            else
            {
                Console.WriteLine("⚠️ No profile found, will create new one");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile from DB: {ex.Message}");
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnProfilePictureSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;

        if (_selectedFile != null)
        {
            using var stream = _selectedFile.OpenReadStream(5 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            _profilePictureUrl = $"data:{_selectedFile.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}";

            Snackbar.Add("Profile picture selected. Click Save to upload.", Severity.Info);
        }
    }


    private void OnCancel()
    {
        Nav.NavigateTo("/");
    }

    private async Task OnSaveAsync()
    {
        if (string.IsNullOrWhiteSpace(_username))
        {
            Snackbar.Add("Username is required.", Severity.Warning);
            return;
        }

        _saving = true;

        try
        {
            var client = await AuthClient.GetAuthenticatedClientAsync();

            // ✅ 1. Upload profile picture IF selected
            if (_selectedFile != null)
            {
                var uploadedUrl = await UploadProfilePicture(_selectedFile, client);

                if (string.IsNullOrWhiteSpace(uploadedUrl))
                {
                    Snackbar.Add("Profile picture upload failed.", Severity.Error);
                    _saving = false;
                    return;
                }

                _profilePictureUrl = uploadedUrl;
            }

            // ✅ 2. Save profile with UPDATED avatar URL
            var update = new ProfileUpdateModel
            {
                Id = _userGuid,
                Username = string.IsNullOrWhiteSpace(_username) ? null : _username.Trim(),
                AvatarUrl = string.IsNullOrWhiteSpace(_profilePictureUrl)
         ? null
         : _profilePictureUrl,
                UpdatedAt = DateTime.UtcNow
            };

            await client
                .From<ProfileUpdateModel>()
                .Update(update);

            ProfileState.SetProfile(update.Username, update.AvatarUrl);


            // ✅ 3. Sync header instantly

            Snackbar.Add("Profile updated successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("23505") ||
                ex.Message.Contains("profiles_username_key") ||
                ex.Message.Contains("duplicate key"))
            {
                Snackbar.Add("Username already exists. Please choose another one.", Severity.Error);
            }
            else
            {
                Snackbar.Add("Failed to update profile.", Severity.Error);
                Console.WriteLine($"Save error: {ex.Message}");
            }
        }
        finally
        {
            _saving = false;
            _selectedFile = null;
        }
    }

    private async Task<string> UploadProfilePicture(IBrowserFile file, Supabase.Client client)
    {
        try
        {
            var maxFileSize = 5 * 1024 * 1024;

            if (file.Size > maxFileSize)
            {
                Snackbar.Add("File size must be less than 5MB", Severity.Warning);
                return string.Empty;
            }

            using var stream = file.OpenReadStream(maxFileSize);
            var buffer = new byte[file.Size];
            await stream.ReadAsync(buffer);

            // ✅ Use _userGuid.ToString() instead of _userId
            var fileName = $"{_userGuid}/{Guid.NewGuid()}{Path.GetExtension(file.Name)}";

            Console.WriteLine($"📤 Uploading file: {fileName}");

            await client.Storage
                .From("avatars")
                .Upload(buffer, fileName, new Supabase.Storage.FileOptions
                {
                    ContentType = file.ContentType,
                    Upsert = true
                });

            var publicUrl = client.Storage
                .From("avatars")
                .GetPublicUrl(fileName);

            Console.WriteLine($"✅ Profile picture uploaded: {publicUrl}");
            return publicUrl;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error uploading profile picture: {ex.Message}");
            Snackbar.Add($"Upload error: {ex.Message}", Severity.Error);
            return string.Empty;
        }
    }
}