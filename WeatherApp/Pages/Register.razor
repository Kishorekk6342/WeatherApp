@page "/register"
@inject JsSupabaseAuthService JsAuth
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudPaper Class="mx-auto mt-8 pa-6" MaxWidth="500px" Elevation="10">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">
        Create Account
    </MudText>

    <!-- USERNAME -->
    <MudTextField @bind-Value="_username"
                  Label="Username"
                  Variant="Variant.Outlined"
                  Required="true"
                  RequiredError="Username is required."
                  FullWidth="true" />

    <!-- EMAIL -->
    <MudTextField @bind-Value="_email"
                  Label="Email"
                  Variant="Variant.Outlined"
                  InputType="InputType.Email"
                  Required="true"
                  RequiredError="Email is required."
                  Validation="@(new Func<string, string>(ValidateEmail))"
                  FullWidth="true"
                  Class="mt-2" />


    <!-- PASSWORD -->
    <MudTextField @bind-Value="_password"
                  Label="Password"
                  Variant="Variant.Outlined"
                  InputType="InputType.Password"
                  Required="true"
                  RequiredError="Password is required."
                  FullWidth="true"
                  Class="mt-2" />

    <!-- CONFIRM PASSWORD -->
    <MudTextField @bind-Value="_confirm"
                  Label="Confirm Password"
                  Variant="Variant.Outlined"
                  InputType="InputType.Password"
                  Required="true"
                  RequiredError="Please confirm your password."
                  FullWidth="true"
                  Class="mt-2" />

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudText Color="Color.Error" Align="Align.Center" Class="mt-3">
            @_error
        </MudText>
    }

    @if (!string.IsNullOrWhiteSpace(_successMessage))
    {
        <MudText Color="Color.Success" Align="Align.Center" Class="mt-3">
            @_successMessage
        </MudText>
    }

    <MudButton Class="mt-4"
               Variant="Variant.Filled"
               Color="Color.Primary"
               FullWidth="true"
               Disabled="_busy"
               OnClick="OnRegisterAsync">
        REGISTER
    </MudButton>

    <MudText Align="Align.Center" Class="mt-3">
        Already have an account?
        <MudLink Href="/login"> Login</MudLink>
    </MudText>
</MudPaper>

@code {
    private string _username = string.Empty;
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _confirm = string.Empty;
    private string _error = string.Empty;
    private string _successMessage = string.Empty;
    private bool _busy = false;

    private string ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return "Email is required";

        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email ? null : "Invalid email format";
        }
        catch
        {
            return "Invalid email format";
        }
    }


    private async Task OnRegisterAsync()
    {
        _error = string.Empty;
        _successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(_username) ||
            string.IsNullOrWhiteSpace(_email) ||
            string.IsNullOrWhiteSpace(_password) ||
            string.IsNullOrWhiteSpace(_confirm))
        {
            _error = "Please fill all required fields.";
            return;
        }

        if (_password.Length < 6)
        {
            _error = "Password should be at least 6 characters.";
            return;
        }

        if (_password != _confirm)
        {
            _error = "Passwords do not match.";
            return;
        }

        _busy = true;

        try
        {
            // Call the JS registration function
            var result = await JsAuth.RegisterAsync(_email, _password, _username);

            if (result)
            {
                _successMessage = "✅ Account created! Please check your email to verify before logging in.";
                Snackbar.Add("Registration successful! ", Severity.Success);

                // Wait a bit then redirect
                await Task.Delay(2000);
                Nav.NavigateTo("/login");
            }
            else
            {
                _error = "Could not create your account. Please try again.";
            }
        }
        catch (Exception ex)
        {
            var errorMsg = ex.Message.ToLower();

            if (errorMsg.Contains("already") || errorMsg.Contains("exists"))
            {
                _error = "This email is already registered.";
            }
            else if (errorMsg.Contains("invalid"))
            {
                _error = "Please provide a valid email address.";
            }
            else
            {
                _error = $"Registration failed: {ex.Message}";
            }

            Console.WriteLine($"❌ Registration error: {ex.Message}");
            Snackbar.Add(_error, Severity.Error);
        }
        finally
        {
            _busy = false;
        }
    }
}