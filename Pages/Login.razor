@page "/login"
@inject JsSupabaseAuthService JsAuth
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudPaper Class="mx-auto mt-8 pa-6" MaxWidth="500px" Elevation="10">
    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">
        Login
    </MudText>

    <MudTextField @bind-Value="_email"
                  Label="Email"
                  Variant="Variant.Outlined"
                  InputType="InputType.Email"
                  Required="true"
                  RequiredError="Email is required."
                  FullWidth="true" />

    <MudTextField @bind-Value="_password"
                  Label="Password"
                  Variant="Variant.Outlined"
                  InputType="InputType.Password"
                  Required="true"
                  RequiredError="Password is required."
                  FullWidth="true"
                  Class="mt-2" />

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudText Color="Color.Error" Align="Align.Center" Class="mt-3">
            @_error
        </MudText>
    }

    <MudButton Class="mt-4"
               Variant="Variant.Filled"
               Color="Color.Primary"
               FullWidth="true"
               Disabled="_busy"
               OnClick="OnLoginAsync">
        LOGIN
    </MudButton>

    <MudText Align="Align.Center" Class="mt-3">
        Don't have an account?
        <MudLink Href="/register"> Register</MudLink>
    </MudText>
</MudPaper>

@code {
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _error = string.Empty;
    private bool _busy = false;

    private async Task OnLoginAsync()
    {
        _error = string.Empty;

        if (string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_password))
        {
            _error = "Please enter your email and password.";
            return;
        }

        _busy = true;

        try
        {
            var user = await JsAuth.LoginAsync(_email, _password);

            if (user == null)
            {
                _error = "Invalid email or password.";
                return;
            }

            Snackbar.Add("Login successful!", Severity.Success);
            Nav.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            _error = ex.Message.Contains("Invalid login credentials", StringComparison.OrdinalIgnoreCase)
                ? "Invalid email or password."
                : "Login failed. Please try again.";
        }
        finally
        {
            _busy = false;
        }
    }
}